<apex:page standardController="contact" extensions="TaskChatterController" showHeader="false" sidebar="false" >
    <apex:slds />
    <html>
        <head>
            <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
            <script src="http://www.datejs.com/build/date.js" type="text/javascript"></script>

            <script>
                var currentOffset=0;
            var contId = '{!contactObj}';
            var email = '{!email}'; 
           // var ownerName = '{!ownerName}';
            $(document).ready(function(){
                loadChat();
            });
                $(window).scroll(function() {
                    if($(window).scrollTop() == $(document).height() - $(window).height()) {
                           // ajax call get data from server and append to the div
                        console.log('$(window).scrollTop()'+$(window).scrollTop());
                        loadChat();
                    }
                });
            function loadChat(){
                var FinalVhatList={};
                var offset=currentOffset.toString();
                var data = {offset:offset,contactId:contId};
                var dataJson = JSON.stringify(data);
                $('#ChatterSpinner').show();
                Visualforce.remoting.Manager.invokeAction(
                                 '{!$RemoteAction.TaskChatterController.loadChatCOntroller}',
                                 dataJson,
                                loadChatResult
                                 ,{buffer:false}
                             );
                            
                         
            }
            function loadChatResult(res,event){
                $('#ChatterSpinner').hide();
                currentOffset += 10;
                var jsonObject = JSON.parse(unescapedHtml(res));
                var myArray =[];
                var inKey ;
                var outKey ;
                var inVal;
                var outVal;
                var inData;
                var outData ;
                var formatted_date;
                var formatted_time;
                var ownerName='';
                if(event.status){
                    if(jsonObject.hasError == false){
                        FinalVhatList = jsonObject.chat;
                        $.each(FinalVhatList, function( key, value ) {
                            if(value.LiveText__Transcript_Summary_1__c!= undefined && value.LiveText__Transcript_Summary_1__c!= ""){
                                var removeHtml = value.LiveText__Transcript_Summary_1__c;
                                ownerName = value.Owner.Name;
                                var comment = removeHtml.split('</p>');
                                //var comment = textFInal.split("\n");
                                $.each(comment, function( key, value ) {
                                    if(value.trim() !="" ){
                                    var splitBr = value.split('<br/>');
                                    $.each(splitBr, function( key, value ) {
                                        if(value.trim() !="" ){
                                        if(value.indexOf('<') != -1){
                                        var value = $(value).text();
                                        }
                                        if (value.indexOf('Session Started') != -1) {
                                            dateVal = value.split(',')+1[1];
                                            outVal = dateVal.split(' at ')[0];
                                            //Mon , February 25th,2019
                                            var str= outVal.split(',')[1];//February 25th
                                            var str1= outVal.split(',')[2];//2019
                                            var strr=str+str1;
                                            strr=strr.replace(/th/g,'');
                                            var mydate = new Date(strr);
                                            var months = ["JAN", "FEB", "MAR","APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
                                            formatted_date = months[(mydate.getMonth())] + ' ' +mydate.getDate() +"," + mydate.getFullYear()

                                            console.log('Date Value'+formatted_date);


                                        }
                                        
                                        if (value.indexOf(ownerName) != -1 || value.indexOf('+') != -1 || value.indexOf('Auto-') != -1) {
                                            myArray.push=value;
                                            inVal = value;
                                            inKey = key+1;
                                        }
                                        
                                        if (value.indexOf('(') != -1){
                                            myArray.push=value;
                                            inVal = value;
                                            inKey = key+1;
                                        }    
                                        if(key == inKey){
                                            myArray.push=value;
                                            inData = value;
                                        } 
                                        /*if(key == outKey){
                                            myArray.push=value;
                                            outData = value;
                                        } */
                                        console.log(myArray);
                                        if(outVal!=undefined && outVal!=""){
                                            /*var dataHtml ='<li class="slds-chat-listitem slds-chat-listitem_bookend">';
                                             dataHtml +='<div class="slds-chat-bookend">';
                                              dataHtml+='<span class="slds-icon_container slds-icon-utility-chat slds-chat-icon">';
                                                dataHtml+='<svg class="slds-icon slds-icon_x-small slds-icon-text-default" aria-hidden="true">';
                                                  dataHtml+='<use xlink:href="/assets/icons/utility-sprite/svg/symbols.svg#chat"></use>';
                                                dataHtml+='</svg>';
                                              dataHtml+='</span>';
                                              dataHtml+='<p>Chat started at â€¢ '+outVal+'</p>';
                                            dataHtml+='</div>';
                                            dataHtml+='</li>';
                                            outVal ='';
                                            $('#srd-grp-discussion').append(dataHtml);*/

                                        }
                                        if(inVal!=undefined && inVal!="" && inData!=undefined && inData!=''){
                                            var finalInVal =inVal.split(' at ');
                                           //Parse Time
                                            var str= finalInVal[1].split(':')[0];
                                            var str1= finalInVal[1].split(':')[1];
                                            var str2= finalInVal[1].split(':')[2];
                                            str2=str2.split(' ')[1];
                                            formatted_time =str+':'+str1+' '+str2;
                                            console.log('full time---'+formatted_time);

                                            var dataHtml='<tr class="slds-hint-parent">';
                                            dataHtml+='<th data-label="Sender" scope="row">';
                                            dataHtml+='<div class="slds-truncate" title="" >'+finalInVal[0]+'</div>';
                                            dataHtml+='</th>';
                                            dataHtml+='<td data-label="Message">';
                                            dataHtml+='<div class="slds-truncate" title="'+inData+'" style="max-width: 22rem;">'+inData+'</div>';
                                            dataHtml+='</td>';
                                            dataHtml+='<td data-label="Date Time">';
                                            dataHtml+='<div class="slds-truncate" title=""> '+formatted_date+'&nbsp;&nbsp;'+formatted_time+'</div>';
                                            dataHtml+='</td>';
                                            dataHtml+='</tr>';
                                            inVal='';
                                            inData='';
                                            outVal='';
                                            $('#chatTableId').append(dataHtml);
                                        } 
                                         }
                                });
                                    }
                                });
                            }
                        });
                        
                    }
                }
                              
            }
            
            function unescapedHtml(){
                return $("<span />", { html: arguments[0] }).text();
            }
            </script>
        </head>
        <body>
            <div>
                <div class="slds-spinner_container" id="ChatterSpinner" style="display: none;z-index:10;">
                    <div aria-hidden="true" class="slds-spinner slds-spinner--small" role="alert" style="left: 47% !important;">
                        <div class="slds-spinner__dot-a"></div>
                        <div class="slds-spinner__dot-b"></div>
                    </div>
                </div>
                <div id="sr-discussion--block" style="background:white;position:relative;" class="">
                    <section role="log" class="slds-chat">
                         <ul class="slds-chat-list slds-border_bottom slds-scrollable_y slds-p-horizontal_large slds-p-bottom_large" id="srd-grp-discussion">
                        
                        </ul>
                        <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
                            <thead>
                                <tr class="slds-line-height_reset">
                                    <th class="" scope="col">
                                        <div class="slds-truncate" style="width:80px;text-align:center" title="Sender" >Sender</div>
                                    </th>
                                    <th class="" scope="col">
                                        <div class="slds-truncate" style="width:250px" title="Message">Message</div>
                                    </th>
                                    <th class="" scope="col">
                                        <div class="slds-truncate" style="width:100px;text-align:center" title="Date Time">Date and Time</div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id ="chatTableId">
                            
                            </tbody>
                        </table>
                    </section>
                </div>
            </div>    
        </body>
    </html>
</apex:page>